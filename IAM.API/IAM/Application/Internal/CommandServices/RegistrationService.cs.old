using OsitoPolar.IAM.Service.Application.Internal.OutboundServices;
using OsitoPolar.IAM.Service.Domain.Model.Aggregates;
using OsitoPolar.IAM.Service.Domain.Repositories;
using OsitoPolar.IAM.Service.Domain.Services;
using OsitoPolar.IAM.Service.Interfaces.REST.Resources;
// using OsitoPolarPlatform.API.Profiles.Interfaces.ACL;
// using OsitoPolarPlatform.API.SubscriptionsAndPayments.Interfaces.ACL;
// using OsitoPolarPlatform.API.Notifications.Interfaces.ACL;
using OsitoPolar.IAM.Service.Shared.Domain.Repositories;
// using OsitoPolarPlatform.API.SubscriptionsAndPayments.Domain.Services;

namespace OsitoPolar.IAM.Service.Application.Internal.CommandServices;

/// <summary>
/// Service for handling complete user registration with payment and profile creation
/// </summary>
public class RegistrationService : IRegistrationService
{
    private readonly IUserRepository _userRepository;
    private readonly IProfilesContextFacade _profilesFacade;
    private readonly ISubscriptionContextFacade _subscriptionFacade;
    private readonly INotificationContextFacade _notificationFacade;
    private readonly IPaymentProvider _paymentProvider;
    private readonly IHashingService _hashingService;
    private readonly IUnitOfWork _unitOfWork;

    public RegistrationService(
        IUserRepository userRepository,
        IProfilesContextFacade profilesFacade,
        ISubscriptionContextFacade subscriptionFacade,
        INotificationContextFacade notificationFacade,
        IPaymentProvider paymentProvider,
        IHashingService hashingService,
        IUnitOfWork unitOfWork)
    {
        _userRepository = userRepository;
        _profilesFacade = profilesFacade;
        _subscriptionFacade = subscriptionFacade;
        _notificationFacade = notificationFacade;
        _paymentProvider = paymentProvider;
        _hashingService = hashingService;
        _unitOfWork = unitOfWork;
    }

    public async Task<RegisterWithPaymentResponse> RegisterWithPaymentAsync(RegisterWithPaymentResource request)
    {
        try
        {
            Console.WriteLine($"[Registration] Starting registration for {request.Username} as {request.UserType}");

            // 1. Validate user type
            if (request.UserType != "Owner" && request.UserType != "Provider")
            {
                return new RegisterWithPaymentResponse
                {
                    Success = false,
                    ErrorMessage = "Invalid user type. Must be 'Owner' or 'Provider'"
                };
            }

            // 2. Validate plan ID matches user type
            var subscriptionData = await _subscriptionFacade.GetFullSubscriptionData(request.PlanId);
            if (subscriptionData == null)
            {
                return new RegisterWithPaymentResponse
                {
                    Success = false,
                    ErrorMessage = $"Invalid plan ID: {request.PlanId}"
                };
            }

            // Validate plan type matches user type
            var isOwnerPlan = subscriptionData.Value.maxEquipment.HasValue;
            var isProviderPlan = subscriptionData.Value.maxClients.HasValue;

            if (request.UserType == "Owner" && !isOwnerPlan)
            {
                return new RegisterWithPaymentResponse
                {
                    Success = false,
                    ErrorMessage = "Selected plan is not an Owner plan (plans 1-3)"
                };
            }

            if (request.UserType == "Provider" && !isProviderPlan)
            {
                return new RegisterWithPaymentResponse
                {
                    Success = false,
                    ErrorMessage = "Selected plan is not a Provider plan (plans 4-6)"
                };
            }

            // 3. Check if username already exists
            if (_userRepository.ExistsByUsername(request.Username))
            {
                return new RegisterWithPaymentResponse
                {
                    Success = false,
                    ErrorMessage = $"Username {request.Username} is already taken"
                };
            }

            // 4. Check if email is already used
            var ownerEmailExists = await _profilesFacade.CheckOwnerEmailExists(request.Email);
            var providerEmailExists = await _profilesFacade.CheckProviderEmailExists(request.Email);

            if (ownerEmailExists || providerEmailExists)
            {
                return new RegisterWithPaymentResponse
                {
                    Success = false,
                    ErrorMessage = $"Email {request.Email} is already registered"
                };
            }

            // 5. Process payment with Stripe
            Console.WriteLine($"[Registration] Processing payment of {subscriptionData.Value.price} {subscriptionData.Value.currency}");

            var paymentRequest = new PaymentRequest
            {
                Amount = subscriptionData.Value.price,
                Currency = subscriptionData.Value.currency,
                Description = $"{subscriptionData.Value.planName} subscription for {request.Username}",
                CustomerEmail = request.Email,
                CustomerName = $"{request.FirstName} {request.LastName}",
                PaymentToken = request.PaymentToken,
                Metadata = new Dictionary<string, string>
                {
                    { "username", request.Username },
                    { "userType", request.UserType },
                    { "planId", request.PlanId.ToString() },
                    { "planName", subscriptionData.Value.planName }
                }
            };

            var paymentResult = await _paymentProvider.CreatePaymentAsync(paymentRequest);

            if (!paymentResult.Success)
            {
                Console.WriteLine($"[Registration] Payment failed: {paymentResult.ErrorMessage}");
                return new RegisterWithPaymentResponse
                {
                    Success = false,
                    ErrorMessage = $"Payment failed: {paymentResult.ErrorMessage}"
                };
            }

            Console.WriteLine($"[Registration] Payment succeeded: {paymentResult.TransactionId}");

            // 6. Generate random password
            var generatedPassword = GenerateSecurePassword();

            // 7. Create user account
            var hashedPassword = _hashingService.HashPassword(generatedPassword);
            var user = new User(request.Username, hashedPassword);
            await _userRepository.AddAsync(user);
            await _unitOfWork.CompleteAsync();

            Console.WriteLine($"[Registration] User account created with ID: {user.Id}");

            // 8. Create Owner or Provider profile
            int profileId;

            if (request.UserType == "Owner")
            {
                profileId = await _profilesFacade.CreateOwnerProfile(
                    user.Id,
                    request.FirstName,
                    request.LastName,
                    request.Email,
                    request.Street,
                    request.Number,
                    request.City,
                    request.PostalCode,
                    request.Country,
                    request.PlanId,
                    subscriptionData.Value.maxEquipment!.Value
                );

                await _unitOfWork.CompleteAsync();
                Console.WriteLine($"[Registration] Owner profile created with ID: {profileId}");
            }
            else // Provider
            {
                if (string.IsNullOrEmpty(request.CompanyName))
                {
                    return new RegisterWithPaymentResponse
                    {
                        Success = false,
                        ErrorMessage = "Company name is required for Provider registration"
                    };
                }

                profileId = await _profilesFacade.CreateProviderProfile(
                    user.Id,
                    request.CompanyName,
                    request.FirstName,
                    request.LastName,
                    request.Email,
                    request.Street,
                    request.Number,
                    request.City,
                    request.PostalCode,
                    request.Country,
                    request.PlanId,
                    subscriptionData.Value.maxClients!.Value,
                    request.TaxId ?? ""
                );

                await _unitOfWork.CompleteAsync();
                Console.WriteLine($"[Registration] Provider profile created with ID: {profileId}");
            }

            // 9. Send welcome email with credentials
            try
            {
                var emailSubject = $"Welcome to OsitoPolar - Your Account Details";
                var emailBody = $@"
<!DOCTYPE html>
<html>
<head>
    <style>
        body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}
        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
        .header {{ background-color: #2c3e50; color: white; padding: 20px; text-align: center; }}
        .content {{ background-color: #f4f4f4; padding: 20px; }}
        .credentials {{ background-color: white; padding: 15px; margin: 15px 0; border-left: 4px solid #3498db; }}
        .button {{ background-color: #3498db; color: white; padding: 12px 30px; text-decoration: none; display: inline-block; margin: 15px 0; border-radius: 5px; }}
        .footer {{ text-align: center; padding: 20px; color: #777; font-size: 12px; }}
    </style>
</head>
<body>
    <div class=""container"">
        <div class=""header"">
            <h1>üêª Welcome to OsitoPolar!</h1>
        </div>
        <div class=""content"">
            <h2>Hello {request.FirstName}!</h2>
            <p>Thank you for registering as a <strong>{request.UserType}</strong> with OsitoPolar.</p>
            <p>Your subscription to <strong>{subscriptionData.Value.planName}</strong> has been activated.</p>

            <div class=""credentials"">
                <h3>Your Login Credentials:</h3>
                <p><strong>Username:</strong> {request.Username}</p>
                <p><strong>Password:</strong> {generatedPassword}</p>
                <p style=""color: #e74c3c; font-size: 14px;"">‚ö†Ô∏è Please change your password after your first login for security.</p>
            </div>

            <p><strong>Plan Details:</strong></p>
            <ul>
                <li>Plan: {subscriptionData.Value.planName}</li>
                <li>Price: ${subscriptionData.Value.price}/month</li>
                {(request.UserType == "Owner" ? $"<li>Max Equipment: {subscriptionData.Value.maxEquipment} units</li>" : $"<li>Max Clients: {(subscriptionData.Value.maxClients == 0 ? "Unlimited" : subscriptionData.Value.maxClients.ToString())}</li>")}
            </ul>

            <p style=""text-align: center;"">
                <a href=""http://localhost:3000/login"" class=""button"">Login Now</a>
            </p>

            <p>If you have any questions, please don't hesitate to contact our support team.</p>
        </div>
        <div class=""footer"">
            <p>¬© 2025 OsitoPolar. All rights reserved.</p>
            <p>This is an automated email. Please do not reply.</p>
        </div>
    </div>
</body>
</html>";

                await _notificationFacade.SendEmailNotification(
                    request.Email,
                    $"{request.FirstName} {request.LastName}",
                    emailSubject,
                    emailBody
                );

                Console.WriteLine($"[Registration] Welcome email sent to {request.Email}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Registration] Failed to send email: {ex.Message}");
                // Don't fail registration if email fails
            }

            // 10. Return success response
            return new RegisterWithPaymentResponse
            {
                Success = true,
                Message = "Registration completed successfully! Check your email for login credentials.",
                UserId = user.Id,
                Username = request.Username,
                GeneratedPassword = generatedPassword, // Include in response for testing/demo
                UserType = request.UserType,
                ProfileId = profileId,
                TransactionId = paymentResult.TransactionId
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Registration] Error: {ex.Message}");
            Console.WriteLine($"[Registration] Stack trace: {ex.StackTrace}");

            return new RegisterWithPaymentResponse
            {
                Success = false,
                ErrorMessage = $"Registration failed: {ex.Message}"
            };
        }
    }

    /// <summary>
    /// Generate a secure random password
    /// </summary>
    private string GenerateSecurePassword()
    {
        const string uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const string lowercase = "abcdefghijklmnopqrstuvwxyz";
        const string digits = "0123456789";
        const string special = "!@#$%^&*";
        const string allChars = uppercase + lowercase + digits + special;

        var random = new Random();
        var password = new char[12];

        // Ensure at least one of each type
        password[0] = uppercase[random.Next(uppercase.Length)];
        password[1] = lowercase[random.Next(lowercase.Length)];
        password[2] = digits[random.Next(digits.Length)];
        password[3] = special[random.Next(special.Length)];

        // Fill the rest randomly
        for (int i = 4; i < password.Length; i++)
        {
            password[i] = allChars[random.Next(allChars.Length)];
        }

        // Shuffle
        return new string(password.OrderBy(x => random.Next()).ToArray());
    }
}
